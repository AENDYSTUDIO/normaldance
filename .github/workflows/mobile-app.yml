name: Mobile App CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'mobile-app/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'mobile-app/**'
  workflow_dispatch:

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  test-mobile:
    name: Test Mobile App
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'mobile-app/package-lock.json'
        
    - name: Install dependencies
      working-directory: ./mobile-app
      run: npm ci
      
    - name: Install Expo CLI
      working-directory: ./mobile-app
      run: npm install -g @expo/cli
      
    - name: Run linting
      working-directory: ./mobile-app
      run: npm run lint
      
    - name: Run type checking
      working-directory: ./mobile-app
      run: npm run type-check
      
    - name: Run unit tests
      working-directory: ./mobile-app
      run: npm test
      env:
        JEST_JUNIT_OUTPUT_DIR: ./test-results/junit
      
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: mobile-test-results
        path: |
          mobile-app/test-results/
          mobile-app/coverage/
        retention-days: 30

  build-mobile:
    name: Build Mobile App
    runs-on: macos-latest
    needs: test-mobile
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'mobile-app/package-lock.json'
        
    - name: Install dependencies
      working-directory: ./mobile-app
      run: npm ci
      
    - name: Install Expo CLI
      working-directory: ./mobile-app
      run: npm install -g @expo/cli
      
    - name: Login to Expo
      uses: expo/expo-github-action@v1
      with:
        expo-version: latest
        token: ${{ env.EXPO_TOKEN }}
        
    - name: Build Android
      working-directory: ./mobile-app
      run: eas build --platform android --profile production --non-interactive
      env:
        EAS_BUILD_SECRET: ${{ secrets.EAS_BUILD_SECRET_ANDROID }}
        
    - name: Build iOS
      working-directory: ./mobile-app
      run: eas build --platform ios --profile production --non-interactive
      env:
        EAS_BUILD_SECRET: ${{ secrets.EAS_BUILD_SECRET_IOS }}
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: mobile-build-artifacts
        path: |
          mobile-app/eas-build.json
          mobile-app/build/
        retention-days: 90

  deploy-mobile-staging:
    name: Deploy Mobile App to Staging
    runs-on: macos-latest
    needs: build-mobile
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'mobile-app/package-lock.json'
        
    - name: Install dependencies
      working-directory: ./mobile-app
      run: npm ci
      
    - name: Install Expo CLI
      working-directory: ./mobile-app
      run: npm install -g @expo/cli
      
    - name: Login to Expo
      uses: expo/expo-github-action@v1
      with:
        expo-version: latest
        token: ${{ env.EXPO_TOKEN }}
        
    - name: Deploy to Expo Staging
      working-directory: ./mobile-app
      run: eas update --branch staging --message "Staging deployment from GitHub Actions"
      env:
        EAS_UPDATE_SECRET: ${{ secrets.EAS_UPDATE_SECRET }}

  deploy-mobile-production:
    name: Deploy Mobile App to Production
    runs-on: macos-latest
    needs: build-mobile
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'mobile-app/package-lock.json'
        
    - name: Install dependencies
      working-directory: ./mobile-app
      run: npm ci
      
    - name: Install Expo CLI
      working-directory: ./mobile-app
      run: npm install -g @expo/cli
      
    - name: Login to Expo
      uses: expo/expo-github-action@v1
      with:
        expo-version: latest
        token: ${{ env.EXPO_TOKEN }}
        
    - name: Deploy to Expo Production
      working-directory: ./mobile-app
      run: eas update --branch production --message "Production deployment from GitHub Actions"
      env:
        EAS_UPDATE_SECRET: ${{ secrets.EAS_UPDATE_SECRET }}

  notify-mobile:
    name: Notify Mobile Deployment
    runs-on: ubuntu-latest
    needs: [deploy-mobile-staging, deploy-mobile-production]
    if: always()
    
    steps:
    - name: Send mobile deployment notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#mobile-deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK_MOBILE }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        custom_payload: |
          {
            "attachments": [
              {
                "color": "${{ job.status == 'success' ? 'good' : job.status == 'failure' ? 'danger' : 'warning' }}",
                "title": "Mobile App ${{ github.workflow }} - ${{ job.status }}",
                "title_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                "text": "Mobile app deployment to ${{ needs.deploy-mobile-staging.branch || needs.deploy-mobile-production.branch }} completed",
                "fields": [
                  {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  }
                ]
              }
            ]
          }