# План оптимизации архитектуры NORMALDANCE

## Критические проблемы (Приоритет 1)

### 1. Исправление дефляционной модели
- **Проблема**: Опечатка в `DEFALATIONARY_CONFIG`, неправильный расчет долей
- **Решение**: Исправить расчеты, чтобы treasury/staking считались от burn, а не от amount
- **Файл**: `src/lib/deflationary-model.ts`
- **Статус**: ❌ Требует исправления

### 2. Исправление обработки ошибок в кошельке
- **Проблема**: Методы кошелька бросают исключения вместо возврата 0/null
- **Решение**: Изменить на silent-fail паттерн согласно правилам
- **Файл**: `src/components/wallet/wallet-adapter.tsx`
- **Статус**: ❌ Требует исправления

### 3. Несоответствие схемы БД и auth.ts
- **Проблема**: В auth.ts используется поле `wallet`, в schema.prisma - `walletAddress`
- **Решение**: Унифицировать названия полей
- **Файлы**: `src/lib/auth.ts`, `prisma/schema.prisma`
- **Статус**: ❌ Требует исправления

## Важные улучшения (Приоритет 2)

### 4. Добавление Helmet для безопасности
- **Проблема**: Helmet в зависимостях, но не используется в server.ts
- **Решение**: Подключить middleware безопасности
- **Файл**: `server.ts`
- **Статус**: ❌ Требует добавления

### 5. Оптимизация IPFS клиента
- **Проблема**: Использует браузерные API на сервере
- **Решение**: Добавить проверки окружения
- **Файл**: `src/lib/ipfs-enhanced.ts`
- **Статус**: ❌ Требует исправления

### 6. Улучшение валидации API
- **Проблема**: Отсутствует Zod валидация в некоторых API роутах
- **Решение**: Добавить middleware валидации
- **Файлы**: `src/app/api/**/*.ts`
- **Статус**: ❌ Требует проверки

## Архитектурные улучшения (Приоритет 3)

### 7. Унификация стратегии деплоя
- **Проблема**: Конфликт между правилами (tsx) и package.json (next)
- **Решение**: Определить единую стратегию
- **Файлы**: `package.json`, документация
- **Статус**: ❌ Требует решения

### 8. Оптимизация аудио плеера
- **Проблема**: Избыточная сложность компонента (1000+ строк)
- **Решение**: Разбить на подкомпоненты
- **Файл**: `src/components/audio/audio-player.tsx`
- **Статус**: ❌ Требует рефакторинга

### 9. Добавление мониторинга производительности
- **Проблема**: Отсутствует детальный мониторинг
- **Решение**: Интегрировать Sentry, добавить метрики
- **Статус**: ❌ Требует добавления

## Прогресс выполнения

- [x] Исправить дефляционную модель
- [x] Исправить обработку ошибок кошелька  
- [x] Унифицировать схему БД
- [x] Добавить Helmet
- [x] Оптимизировать IPFS клиент
- [ ] Улучшить валидацию API
- [ ] Унифицировать стратегию деплоя
- [ ] Рефакторить аудио плеер
- [ ] Добавить мониторинг

## Метрики качества

### Текущее состояние
- Покрытие тестами: ~60%
- Размер bundle: ~2.5MB
- Время загрузки: ~3.2s
- Количество критических проблем: 0 ✅

### Целевые показатели
- Покрытие тестами: >80%
- Размер bundle: <2MB
- Время загрузки: <2s
- Количество критических проблем: 0

## Следующие шаги

1. Начать с критических проблем (Приоритет 1)
2. Провести тестирование после каждого исправления
3. Обновить документацию
4. Перейти к улучшениям Приоритета 2