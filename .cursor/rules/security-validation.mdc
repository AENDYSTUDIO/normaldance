---
alwaysApply: true
---
# Security & Validation Rules

- **Сессии/кэш**: используйте Redis согласно инфраструктурным правилам; не храните секреты в коде.
- **База данных**: импортируйте только глобальный Prisma из [`src/lib/db.ts`](mdc:src/lib/db.ts); не создавайте новые клиенты.
- **Валидация ввода**: валидируйте и санитизируйте пользовательские данные (XSS/SSRF/инъекции). Не логируйте секреты/PII.
- **CORS/Headers**: соблюдайте настройки для кастомного сервера [`server.ts`](mdc:server.ts); путь Socket.IO строго `/api/socketio`.
- **Загрузка файлов**: придерживайтесь `ipfs-enhanced` с автоматическим чанкингом >10MB и fallback на CDN.
- **Ключи и конфиг**: используйте [`config/secrets-config.json`](mdc:config/secrets-config.json) и шаблоны [`config/secrets-templates.js`](mdc:config/secrets-templates.js). Не коммитьте реальные секреты.
---
globs: src/api/**,src/lib/auth.ts,src/lib/validation.ts,src/middleware/**
description: Security patterns, validation, and authentication rules
---

# Security & Validation Rules

## Authentication & Authorization
- **Session management**: Use Redis for session storage and validation
- **JWT tokens**: Implement proper JWT token validation and refresh
- **API protection**: All API routes must have proper authentication middleware
- **Role-based access**: Implement RBAC for different user types (artist, listener, admin)

## Input Validation
- **Schema validation**: Use Zod for all input validation schemas
- **Sanitization**: Sanitize all user inputs before database operations
- **File uploads**: Validate file types, sizes, and content before processing
- **SQL injection**: Use Prisma ORM to prevent SQL injection attacks

## Web3 Security
- **Wallet validation**: Always validate wallet signatures and addresses
- **Transaction verification**: Verify transaction signatures before processing
- **Program ID validation**: Never trust user-provided program IDs
- **Rate limiting**: Implement rate limiting for Web3 operations

## Data Protection
- **Encryption**: Encrypt sensitive data at rest and in transit
- **PII handling**: Properly handle personally identifiable information
- **GDPR compliance**: Implement data deletion and export functionality
- **Audit logging**: Log all security-relevant operations

## Error Handling Security
- **Information disclosure**: Don't expose sensitive information in error messages
- **Logging**: Log security events without exposing sensitive data
- **Error boundaries**: Implement proper error boundaries for security
- **Graceful degradation**: Handle security failures gracefully